<%- include('../partials/user/header') %>

    <!-- Include SweetAlert library (CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="/" rel="nofollow">Home</a>
                    <span></span> Shop
                    <span></span> Your Orders
                </div>
            </div>
        </div>

        <section class="pt-150 pb-150">
            <div class="container">
                <div class="row">
                    <aside class="col-md-3">
                        <div class="sidebar">
                            <h4>Account Settings</h4><br>
                            <ul class="list-unstyled">
                                <li><a href="/profile">Profile</a></li>
                                <li><a href="/orders">Orders</a></li>
                                <li><a href="/wishlist">Wishlist</a></li>
                                <li><a href="/address">Address</a></li>
                                <li><a href="/wallet">Wallet</a></li>
                                <li><a href="/logout-user">Logout</a></li>
                            </ul>
                        </div>
                    </aside>

                    <div class="col-md-9">
                        <h4>Your Orders</h4><br>
                        <% if (orders && orders.length> 0) { %>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Total</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% orders.forEach(order=> { %>
                                        <tr>
                                            <td>
                                                <ul>
                                                    <%order.orderedItems.forEach(item=>{%>
                                                        <li>
                                                            <strong><%=item.product.productName%></strong>
                                                        </li>
                                                    <%})%>
                                                </ul>
                                            </td>
                                            <td>
                                                <%= order.createdAt.toLocaleDateString() %>
                                            </td>
                                            <td>
                                                <%= order.status %>
                                            </td>
                                            <td>â‚¹<%=order.finalAmount.toLocaleString() %>
                                            </td>
                                            <td>
                                                <a href="/order-details?id=<%= order._id %>"
                                                    class="btn btn-success">View Details</a>
                                                <% if (order.status !=='Cancelled' && order.status !=='Completed' ) { %>
                                                    <button class="btn btn-danger"
                                                        onclick="confirmCancelOrder('<%= order._id %>')">Cancel
                                                        Order</button>
                                                    <% } %>
                                            </td>
                                        </tr>
                                        <% }) %>
                                </tbody>
                            </table>
                            <div class="pagination-area mt-15 mb-50 container">
                                <nav aria-label="Page navigation example">
                                    <ul class="pagination justify-content-start">
                                        <!-- Previous Button -->
                                        <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                                            <a class="page-link d-flex justify-content-center align-items-center" 
                                            href="<%= currentPage === 1 ? '#' : `?page=${currentPage - 1}` %>"
                                            <%= currentPage === 1 ? 'aria-disabled="true"' : '' %>>
                                                <span class="material-icons">chevron_left</span>
                                            </a>
                                        </li>
                    
                                        <!-- Page Numbers -->
                                        <% 
                                        let startPage = Math.max(1, currentPage - 2);
                                        let endPage = Math.min(totalPages, startPage + 4);
                                        
                                        if (endPage - startPage < 4) {
                                            startPage = Math.max(1, endPage - 4);
                                        }
                                        
                                        if (startPage > 1) { %>
                                            <li class="page-item">
                                                <a class="page-link" href="?page=1">1</a>
                                            </li>
                                            <% if (startPage > 2) { %>
                                                <li class="page-item disabled">
                                                    <span class="page-link">...</span>
                                                </li>
                                            <% } %>
                                        <% } %>
                    
                                        <% for(let i = startPage; i <= endPage; i++) { %>
                                            <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                                <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                                            </li>
                                        <% } %>
                    
                                        <% if (endPage < totalPages) { %>
                                            <% if (endPage < totalPages - 1) { %>
                                                <li class="page-item disabled">
                                                    <span class="page-link">...</span>
                                                </li>
                                            <% } %>
                                            <li class="page-item">
                                                <a class="page-link" href="?page=<%= totalPages %>"><%= totalPages %></a>
                                            </li>
                                        <% } %>
                    
                                        <!-- Next Button -->
                                        <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                                            <a class="page-link d-flex justify-content-center align-items-center" 
                                            href="<%= currentPage === totalPages ? '#' : `?page=${currentPage + 1}` %>"
                                            <%= currentPage === totalPages ? 'aria-disabled="true"' : '' %>>
                                                <span class="material-icons">chevron_right</span>
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                            </div><br>
                            <% } else { %>
                                <p>You have no orders yet.</p>
                                <% } %>
                    </div>
                </div>
            </div>
            
        </section>
    </main>

    <%- include('../partials/user/footer') %>

        <script>
            function confirmCancelOrder(orderId) {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, cancel it!',
                    input: 'text',
                    inputPlaceholder: 'Enter reason for cancellation',
                    inputValidator: (value) => {
                        if (!value) {
                            return 'You need to provide a reason for cancellation!'
                        }
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const reason = result.value;
                        window.location.href = `/cancel-order?id=${orderId}&reason=${encodeURIComponent(reason)}`;
                    }
                });
            }

        </script>